name: Auto Build and Deploy to Main

on:
  push:
    branches:
      - dev  # 只在 dev 分支觸發
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ========== 1. 檢出 dev 分支 ==========
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 獲取完整歷史，用於 git 操作

      # ========== 2. 檢查是否需要更新版本號 ==========
      - name: Check for release tag in commit message
        id: autotag_check
        shell: bash
        run: |-
          message=$(git log -n 1 --pretty=format:"%s")
          if [[ $message == *"[release]"* || $message == *"[release patch]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=patch" >> "$GITHUB_OUTPUT"
          elif [[ $message == *"[release minor]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=minor" >> "$GITHUB_OUTPUT"
          elif [[ $message == *"[release major]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=major" >> "$GITHUB_OUTPUT"
          else
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
            echo "bump=" >> "$GITHUB_OUTPUT"
          fi

      # ========== 3. 計算新版本號 ==========
      - name: Generate new version tag
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        id: autotag
        uses: phish108/autotag-action@v1.1.64
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          release-branch: ''
          bump: ${{ steps.autotag_check.outputs.bump }}
          dry-run: true

      # ========== 4. 更新 manifest.json 和 package.json 的版本號 ==========
      - name: Prepare version string for replacement
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        id: package_version
        run: |-
          echo 'result="version": "${{ steps.autotag.outputs.new-tag }}"' >> "$GITHUB_OUTPUT"

      - name: Update manifest.json version
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          include: manifest.json
          find: '"version": "\d+\.\d+\.\d+"'
          replace: ${{ steps.package_version.outputs.result }}
          regex: true

      - name: Update package.json version
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          include: package.json
          find: '"version": "\d+\.\d+\.\d+"'
          replace: ${{ steps.package_version.outputs.result }}
          regex: true

      # ========== 5. 安裝依賴並打包 ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - name: Install dependencies
        run: pnpm i

      - name: Format code
        run: pnpm format

      - name: Build
        run: pnpm build

      # ========== 6. 部署到 main 分支 ==========
      - name: Deploy to main branch
        run: |
          # 配置 git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 暫存當前的版本文件（如果有更新版本號）
          if [ "${{ steps.autotag_check.outputs.should_tag }}" == "true" ]; then
            git add manifest.json package.json
            git commit -m "[bot] Bump version to ${{ steps.autotag.outputs.new-tag }}" || true
            git push origin dev
          fi

          # 暫存打包好的 dist 文件
          mkdir -p /tmp/deploy
          cp -r dist/ /tmp/deploy/
          cp manifest.json /tmp/deploy/
          cp -r i18n/ /tmp/deploy/ 2>/dev/null || true
          cp README.md /tmp/deploy/ 2>/dev/null || true
          cp LICENSE /tmp/deploy/ 2>/dev/null || true
          
          # 切換到 main 分支（強制切換，忽略本地改動）
          git fetch origin main:main 2>/dev/null || git checkout --orphan main
          git checkout -f main
          
          # 清空 main 分支的所有內容
          git rm -rf . 2>/dev/null || true
          rm -rf * .* 2>/dev/null || true

          # 複製暫存的文件到 main 分支
          cp -r /tmp/deploy/* .
          
          # 提交到 main 分支
          git add .
          COMMIT_MSG="Auto build from dev - $(git log dev -1 --pretty=format:'%s')"
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          
          # 推送到 main 分支
          git push origin main --force

      # ========== 7. 創建 Git Tag（如果是 release）==========
      - name: Create and push git tag
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        run: |
          git checkout dev
          git tag ${{ steps.autotag.outputs.new-tag }}
          git push origin ${{ steps.autotag.outputs.new-tag }}