name: Auto Build and Deploy

on:
  push:
    branches:
      - dev
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ========== 1. 檢出 dev 分支 ==========
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # ========== 2. 檢查是否需要發布到 main ==========
      - name: Check for release tag in commit message
        id: autotag_check
        shell: bash
        run: |-
          message=$(git log -n 1 --pretty=format:"%s")
          if [[ $message == *"[release]"* || $message == *"[release patch]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=patch" >> "$GITHUB_OUTPUT"
          elif [[ $message == *"[release minor]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=minor" >> "$GITHUB_OUTPUT"
          elif [[ $message == *"[release major]"* ]]; then
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
            echo "bump=major" >> "$GITHUB_OUTPUT"
          else
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
            echo "bump=" >> "$GITHUB_OUTPUT"
          fi

      # ========== 3. 計算新版本號（僅在 release 時）==========
      - name: Generate new version tag
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        id: autotag
        uses: phish108/autotag-action@v1.1.64
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          release-branch: ''
          bump: ${{ steps.autotag_check.outputs.bump }}
          dry-run: true

      # ========== 4. 更新版本號（僅在 release 時）==========
      - name: Prepare version string
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        id: package_version
        run: |-
          echo 'result="version": "${{ steps.autotag.outputs.new-tag }}"' >> "$GITHUB_OUTPUT"

      - name: Update manifest.json version
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          include: manifest.json
          find: '"version": "\d+\.\d+\.\d+"'
          replace: ${{ steps.package_version.outputs.result }}
          regex: true

      - name: Update package.json version
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          include: package.json
          find: '"version": "\d+\.\d+\.\d+"'
          replace: ${{ steps.package_version.outputs.result }}
          regex: true

      # ========== 5. 安裝依賴並打包 ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - name: Install dependencies
        run: pnpm i

      - name: Format code
        run: pnpm format

      - name: Build
        run: pnpm build

      # ========== 6. 提交版本號更新到 dev（僅在 release 時）==========
      - name: Commit version bump to dev
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json package.json
          git commit -m "[bot] Bump version to ${{ steps.autotag.outputs.new-tag }}" || true
          git push origin dev

      # ========== 7. 部署到 main 分支（僅在 release 時）==========
      - name: Deploy to main branch
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 暫存打包好的文件
          mkdir -p /tmp/deploy
          cp -r dist/ /tmp/deploy/
          cp manifest.json /tmp/deploy/
          cp -r i18n/ /tmp/deploy/ 2>/dev/null || true
          cp README.md /tmp/deploy/ 2>/dev/null || true
          cp LICENSE /tmp/deploy/ 2>/dev/null || true
          
          # 切換到 main 分支（強制切換）
          git fetch origin main:main 2>/dev/null || git checkout --orphan main
          git checkout -f main
          
          # 清空 main 分支的所有內容（但保留 .git 目錄）
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # 複製文件到 main 分支
          cp -r /tmp/deploy/* .
          
          # 提交到 main 分支
          git add .
          git commit -m "Release ${{ steps.autotag.outputs.new-tag }}" || echo "No changes to commit"
          
          # 推送到 main 分支
          git push origin main --force

      # ========== 8. 創建 Git Tag（僅在 release 時）==========
      - name: Create and push git tag
        if: ${{ steps.autotag_check.outputs.should_tag == 'true' }}
        run: |
          git checkout dev
          git tag ${{ steps.autotag.outputs.new-tag }}
          git push origin ${{ steps.autotag.outputs.new-tag }}

      # ========== 9. 部署到 testing 分支（每次都執行）==========
      - name: Deploy to testing branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 取得當前 commit 資訊
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")

          # 暫存打包好的文件
          mkdir -p /tmp/testing-deploy
          cp -r dist/ /tmp/testing-deploy/
          cp manifest.json /tmp/testing-deploy/
          cp -r i18n/ /tmp/testing-deploy/ 2>/dev/null || true
          cp README.md /tmp/testing-deploy/ 2>/dev/null || true
          cp LICENSE /tmp/testing-deploy/ 2>/dev/null || true

          # 切換到 testing 分支（如果不存在則創建）
          if git fetch origin testing 2>/dev/null; then
            # testing 分支已存在，直接切換
            git checkout -f testing
          else
            # testing 分支不存在，創建孤立分支
            git checkout --orphan testing
          fi

          # 清空 testing 分支的所有內容（但保留 .git 目錄）
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true

          # 複製文件到 testing 分支
          cp -r /tmp/testing-deploy/* .

          # 提交到 testing 分支
          git add .
          git commit -m "Testing build from ${COMMIT_SHA}: ${COMMIT_MSG}" || echo "No changes to commit"

          # 推送到 testing 分支
          git push origin testing --force

      # ========== 10. 顯示結果 ==========
      - name: Summary
        run: |
          if [ "${{ steps.autotag_check.outputs.should_tag }}" == "true" ]; then
            echo "✅ Released version ${{ steps.autotag.outputs.new-tag }} to main branch"
            echo "✅ Also deployed to testing branch"
          else
            echo "✅ Build successful and deployed to testing branch"
            echo "ℹ️  Not deployed to main (no [release] tag in commit message)"
          fi